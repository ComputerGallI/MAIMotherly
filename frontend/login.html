<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MAI – Sign in</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css"/>
  <style>
    /* Page-specific sugar without touching your global styles.css */
    :root {
      --bg1: #f7f1ff;
      --bg2: #e8f7ff;
      --ink: #2c2c2c;
      --muted: #6c6c6c;
      --accent: #7b61ff;
      --accent-2: #00c2ff;
      --ring: rgba(123, 97, 255, .25);
    }
    body {
      background: radial-gradient(1200px 700px at 10% -10%, var(--bg1), transparent 60%),
                  radial-gradient(1200px 700px at 110% 110%, var(--bg2), transparent 60%),
                  #ffffff;
      min-height: 100vh;
    }
    .auth-wrap {
      max-width: 720px; margin: 48px auto; padding: 0 16px;
    }
    .auth-card {
      background: #fff; border: 1px solid #efefef; border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.05);
      overflow: hidden;
    }
    .auth-hero {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      padding: 28px 28px; color: #fff;
    }
    .auth-hero h1 {
      margin: 0; font-size: 28px; letter-spacing:.3px;
    }
    .auth-hero p { margin: 6px 0 0; opacity: .9; }
    .auth-body { padding: 22px 22px 26px; }
    .auth-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .auth-field {
      display: flex; flex-direction: column; gap: 6px;
    }
    .auth-label { font-size: 13px; color: var(--muted); }
    .auth-input {
      border: 1px solid #e6e6e6; border-radius: 12px; padding: 12px 14px; font-size: 15px;
      outline: none; transition: box-shadow .15s, border-color .15s;
    }
    .auth-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--ring);
    }
    .divider {
      display: flex; align-items: center; gap: 10px; margin: 14px 0 0;
      color: var(--muted); font-size: 13px;
    }
    .divider::before, .divider::after {
      content: ""; height: 1px; background: #eaeaea; flex: 1 1 auto;
    }
    .google-btn {
      width: 100%; display: inline-flex; align-items: center; justify-content: center; gap: 10px;
      border: 1px solid #dcdcdc; background: #fff; color: #222; border-radius: 14px;
      padding: 12px 16px; font-weight: 700; letter-spacing:.1px; cursor: pointer;
      transition: transform .08s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .google-btn:hover { transform: translateY(-1px); border-color: #cfcfcf; box-shadow: 0 6px 16px rgba(0,0,0,.06); }
    .google-icon {
      width: 22px; height: 22px; border-radius: 50%; display: grid; place-items: center; overflow: hidden;
    }
    .cta-row { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 14px; }
    .pill.muted {
      background: #f4f4f4; color: #9f9f9f; cursor: not-allowed; border: 1px dashed #e2e2e2;
    }
    .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .topbar .brand { text-decoration: none; }
    .badge {
      font-size: 12px; color: #fff; background: linear-gradient(120deg, #ff8a7a, #ffb86b);
      padding: 6px 10px; border-radius: 999px; display: inline-block; margin-left: 8px;
      box-shadow: 0 6px 16px rgba(255,138,122,.35);
    }
    .foot-note { text-align: center; color: var(--muted); font-size: 12px; margin-top: 16px; }
  </style>
</head>
<body>
  <header class="topbar">
    <a class="brand" href="index.html">MAI</a>
  </header>

  <div class="auth-wrap">
    <div class="auth-card">
      <div class="auth-hero">
        <h1>Welcome back to MAI <span class="badge">MVP</span></h1>
        <p>Sign in to connect your Google Calendar and chat with MAI.</p>
      </div>

      <div class="auth-body">
        <!-- Decorative details (MVP uses Google only) -->
        <div class="auth-grid">
          <div class="auth-field">
            <label class="auth-label" for="displayName">Display name (optional)</label>
            <input id="displayName" class="auth-input" placeholder="e.g., alex" />
            <div class="hint">Used as your <code>user_id</code> for linking Google. If empty, we’ll create one.</div>
          </div>
          <div class="auth-field">
            <label class="auth-label" for="emailDecor">Email (decorative)</label>
            <input id="emailDecor" class="auth-input" placeholder="you@example.com" disabled />
            <div class="hint">Email capture via Google is coming soon.</div>
          </div>
        </div>

        <div class="divider">Continue with</div>

        <!-- Primary: Google sign-in -->
        <button class="google-btn" id="googleLoginBtn" onclick="continueWithGoogle()">
          <span class="google-icon">
            <!-- Simple G icon (inline SVG) -->
            <svg viewBox="0 0 533.5 544.3" width="22" height="22" aria-hidden="true">
              <path fill="#4285f4" d="M533.5 278.4c0-18.5-1.7-36.3-4.7-53.3H272v100.9h146.9c-6.3 34.3-25 63.4-53.3 82.8l86.2 66.7c50.3-46.4 81.7-114.8 81.7-197.1z"/>
              <path fill="#34a853" d="M272 544.3c73.9 0 135.8-24.5 181.1-66.5l-86.2-66.7c-23.9 16-54.4 25.6-94.9 25.6-72.9 0-134.8-49.2-157-115.2l-90.9 70.1C68.2 478.6 161.5 544.3 272 544.3z"/>
              <path fill="#fbbc04" d="M115 321.5c-10.7-31.9-10.7-66.4 0-98.3l-90.9-70.1c-37.8 75.6-37.8 163 0 238.6l90.9-70.2z"/>
              <path fill="#ea4335" d="M272 107.7c39.8-.6 77.1 14.1 105.8 41.2l79.1-79.1C408.2 24.7 343.7 0 272 0 161.5 0 68.1 65.7 26.2 159.8l90.9 70.1c22.1-66 84.1-115.2 157-115.2z"/>
            </svg>
          </span>
          Continue with Google
        </button>

        <!-- Decorative alternatives -->
        <div class="cta-row">
          <button class="pill muted" title="Email sign-in will be available later" disabled>Continue with Email (soon)</button>
          <button class="pill" onclick="location.href='index.html'">Back to MAI</button>
        </div>

        <p class="foot-note">By continuing, you agree to MAI’s Terms & Privacy. Google OAuth used to connect Calendar.</p>
      </div>
    </div>
  </div>

  <script>
    const BACKEND = 'http://127.0.0.1:8000';

    function randomUserId() {
      const animals = ['sparrow','dolphin','lynx','otter','panda','koala','finch','orca'];
      const a = animals[Math.floor(Math.random()*animals.length)];
      const n = Math.floor(Math.random()*9000 + 1000);
      return `${a}-${n}`;
    }

    function setUserLocal(id) {
      localStorage.setItem('username', id);
      // optional decorative email storage
      const email = document.getElementById('emailDecor').value.trim();
      if (email) localStorage.setItem('email', email);
    }

    async function continueWithGoogle() {
      // Determine user_id for OAuth state
      const typed = (document.getElementById('displayName').value || '').trim();
      const userId = typed || randomUserId();

      // Store locally so index.html uses same user_id for /auth/status & calendar calls
      setUserLocal(userId);

      try {
        const r = await fetch(`${BACKEND}/auth/login?user_id=${encodeURIComponent(userId)}`);
        const j = await r.json();
        if (j.auth_url) {
          // Launch Google consent in a new tab
          window.open(j.auth_url, '_blank');
          // Light guidance
          const btn = document.getElementById('googleLoginBtn');
          btn.textContent = 'Open the new tab to finish Google sign-in…';
          btn.style.opacity = '.85';

          // Show a post-consent prompt
          setTimeout(() => {
            if (confirm('Once you finish Google sign-in in the new tab, press OK to check status.')) {
              checkStatusAndGoHome(userId);
            }
          }, 1200);
        } else {
          alert('Could not start Google sign-in. Check backend logs and .env credentials.');
        }
      } catch (e) {
        console.error(e);
        alert('Network error starting Google sign-in.');
      }
    }

    async function checkStatusAndGoHome(userId) {
      try {
        const r = await fetch(`${BACKEND}/auth/status?user_id=${encodeURIComponent(userId)}`);
        const j = await r.json();
        if (j.connected) {
          alert('Google connected ✅');
          location.href = 'index.html';
        } else {
          alert('Still not connected. Finish the Google consent in the other tab, then try again.');
        }
      } catch (e) {
        alert('Could not verify status. Try again.');
      }
    }

    // UX nicety: Enter submits Google flow
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') continueWithGoogle();
    });
  </script>
</body>
</html>
