<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MAI</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>

  <header class="topbar">
    <a class="brand" href="index.html">MAI</a>
    <nav class="top-actions">
      <a class="pill" id="loginBtn" href="login.html">Login</a>
      <button class="pill" id="logoutBtn" style="display:none;" onclick="handleLogout()">Logout</button>
      <a class="pill" id="profileBtn" href="profile.html">Profile</a>
      <button class="pill go-pro-btn" id="goProBtn" onclick="goToPremium()">GO PRO âœ¨</button>
    </nav>
  </header>

  <main class="shell">
    <!-- quiz results section -->
    <section class="card left">
      <h2 class="title soft">Quiz Results</h2>
      <p class="caring-instruction glowing-text">Want to learn more about you? Take a quiz</p>
      <div class="viz-wrap">
        <div class="viz-circle" id="vizCenter">
          <span class="center-text soft" id="centerLabel">Register or Log in</span>
        </div>

        <!-- quiz buttons positioned around the circle -->
        <button class="orbit pill soft" style="--deg:10deg;"  data-target="quizzes/quiz_personality.html" id="btnPersonality">Personality</button>
        <button class="orbit pill soft" style="--deg:190deg;" data-target="quizzes/quiz_stress.html"       id="btnStress">Stress & Anxiety</button>
        <button class="orbit pill soft" style="--deg:350deg;" data-target="quizzes/quiz_love.html"         id="btnLove">Love Language</button>
        <button class="orbit pill soft" style="--deg:95deg;"  data-target="quizzes/quiz_21.html"           id="btn21">21 Questions</button>
      </div>
    </section>

    <!-- wellness reminders -->
    <section class="card right">
      <h2 class="title soft">Reminders</h2>
      <p class="caring-instruction glowing-text">Fueled by your personal quiz results and our conversations</p>
      
      <!-- Current reminders -->
      <div id="currentReminders" style="margin-bottom: 20px;">
        <p class="muted" id="remindersEmpty">No reminders yet</p>
        <div id="reminderList" class="rem-list"></div>
      </div>

      <!-- Recommendations section -->
      <div id="recommendationsSection" style="display: none;">
        <h3 style="color: var(--ink); font-size: 18px; margin: 15px 0 10px;">MAI's Recommendations</h3>
        <div id="recommendationsList" class="recommendations-list">
          <!-- Recommendations will be populated here -->
        </div>
        <div style="margin: 15px 0 10px; display: flex; gap: 10px; align-items: center;">
          <button class="pill small-pill" onclick="selectAllRecommendations()">Select All</button>
          <button class="pill small-pill" onclick="clearAllRecommendations()">Clear All</button>
          <span id="selectedCount" style="font-size: 14px; color: var(--muted);">0 selected</span>
        </div>
      </div>

      <button class="cta pill soft" id="addCalBtn" onclick="addSelectedToCalendar()">Add Selected to Calendar</button>
    </section>

    <!-- mai chat interface -->
    <section class="card full">
      <h2 class="title soft" style="text-align:center">Talk to MAI</h2>
      <p class="caring-instruction glowing-text" style="text-align:center">Get some guidance from MAI</p>
      <div class="chat-box">
        <div class="chat-feed" id="chatFeed">
          <div class="mai-welcome" id="welcomeMessage">
            <strong>MAI:</strong> Talk to me about anything... Stress at work? Relationship issues? Want to talk out your upcoming week? Let's talk it out here ðŸ’œ
          </div>
        </div>
        <div class="chat-input">
          <input id="chatText" type="text" placeholder="type a message..." />
          <button id="chatSend" class="pill soft" onclick="sendMessage()">Send</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Google Calendar Auth Modal -->
  <div id="calendarAuthModal" class="calendar-modal" style="display: none;">
    <div class="calendar-modal-content">
      <div class="calendar-modal-header">
        <h3>Connect Google Calendar</h3>
        <button class="modal-close" onclick="closeCalendarModal()">&times;</button>
      </div>
      <div class="calendar-modal-body">
        <p>To add your selected reminders to Google Calendar, please connect your account:</p>
        <div id="selectedItemsPreview" class="selected-items-preview">
          <!-- Selected items will be shown here -->
        </div>
        <div style="margin-top: 20px; text-align: center;">
          <button class="pill" onclick="connectGoogleCalendar()" style="background: #4285f4; font-size: 16px; padding: 15px 30px;">
            Connect Google Calendar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables for recommendations
    let currentRecommendations = [];
    let selectedRecommendations = new Set();

    // load user data and update UI
    function loadUserInterface(){
      const user = localStorage.getItem('username')
      
      if (user) {
        // user is logged in
        document.getElementById('centerLabel').textContent = `hey ${user}!`
        
        // show logout button, hide login button
        document.getElementById('loginBtn').style.display = 'none'
        document.getElementById('logoutBtn').style.display = 'inline-block'
        
        // update welcome message to be more personal
        document.getElementById('welcomeMessage').innerHTML = 
          `<strong>MAI:</strong> Welcome back, ${user}! I'm here whenever you need to talk. What's been on your mind lately? ðŸ’œ`
        
      } else {
        // user is not logged in
        document.getElementById('loginBtn').style.display = 'inline-block'
        document.getElementById('logoutBtn').style.display = 'none'
        
        // keep default welcome message
        document.getElementById('welcomeMessage').innerHTML = 
          `<strong>MAI:</strong> Talk to me about anything... Stress at work? Relationship issues? Want to talk out your upcoming week? Let's talk it out here ðŸ’œ`
      }

      // update quiz buttons with results
      const personality = localStorage.getItem('quiz_personality') || 'Personality'
      const stress = localStorage.getItem('quiz_stress') || 'Stress & Anxiety'  
      const love = localStorage.getItem('quiz_love') || 'Love Language'
      const questions21 = localStorage.getItem('quiz_21') || '21 Questions'
      
      document.getElementById('btnPersonality').textContent = personality
      document.getElementById('btnStress').textContent = stress
      document.getElementById('btnLove').textContent = love
      document.getElementById('btn21').textContent = questions21
    }

    // logout functionality
    function handleLogout() {
      if (confirm('Are you sure you want to log out?')) {
        localStorage.removeItem('username')
        localStorage.removeItem('email')
        loadUserInterface()
        alert('Logged out successfully!')
        
        // clear chat history and recommendations
        document.getElementById('chatFeed').innerHTML = `
          <div class="mai-welcome">
            <strong>MAI:</strong> Talk to me about anything... Stress at work? Relationship issues? Want to talk out your upcoming week? Let's talk it out here ðŸ’œ
          </div>
        `
        clearRecommendations()
      }
    }

    // go to premium page
    function goToPremium() {
      window.location.href = 'premium.html'
    }

    // quiz button navigation
    document.querySelectorAll('.orbit').forEach(button => {
      button.addEventListener('click', () => {
        window.location.href = button.dataset.target
      })
    })

    // send chat message
    async function sendMessage() {
      const textInput = document.getElementById('chatText')
      const message = textInput.value.trim()
      
      if (!message) return
      
      // add user message to chat
      appendChatMessage('You: ' + message)
      textInput.value = ''
      
      // get user context
      const username = localStorage.getItem('username') || ''
      const personality = localStorage.getItem('quiz_personality') || ''
      const stress = localStorage.getItem('quiz_stress') || ''
      const love = localStorage.getItem('quiz_love') || ''
      const quiz21 = localStorage.getItem('quiz_21') || ''
      const quizSummary = `${personality}, ${stress}, ${love}, ${quiz21}`.replace(/^,+|,+$/g, '')
      
      try {
        const response = await fetch('http://localhost:5000/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            user_input: message,
            username: username,
            quiz_summary: quizSummary
          })
        })
        
        const data = await response.json()
        const aiResponse = data.response || 'Tell me more about that. I\'m here to listen.'
        
        // add AI response to chat
        appendChatMessage('MAI: ' + aiResponse)
        
        // handle recommendations separately
        if (data.suggestions && data.suggestions.length > 0) {
          appendRecommendationsBubble(data.suggestions)
          addRecommendationsToSidebar(data.suggestions)
        }
        
      } catch (error) {
        console.error('Chat error:', error)
        appendChatMessage('MAI: I\'m having trouble connecting right now, but I\'m still here for you. Can you tell me more about how you\'re feeling?')
      }
    }

    // add message to chat feed
    function appendChatMessage(message, type = 'normal') {
      const chatFeed = document.getElementById('chatFeed')
      const messageDiv = document.createElement('div')
      
      messageDiv.textContent = message
      messageDiv.style.margin = '8px 0'
      messageDiv.style.padding = '8px 12px'
      messageDiv.style.borderRadius = '12px'
      
      if (message.startsWith('You:')) {
        messageDiv.style.background = '#f0c6ff'
        messageDiv.style.marginLeft = '20px'
        messageDiv.style.textAlign = 'right'
      } else {
        messageDiv.style.background = '#fff'
        messageDiv.style.border = '1px solid #e0e0e0'
      }
      
      chatFeed.appendChild(messageDiv)
      chatFeed.scrollTop = chatFeed.scrollHeight
    }

    // add recommendations bubble to chat
    function appendRecommendationsBubble(suggestions) {
      const chatFeed = document.getElementById('chatFeed')
      const recommendationsDiv = document.createElement('div')
      
      recommendationsDiv.style.cssText = `
        margin: 8px 0; padding: 12px; border-radius: 12px;
        background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
        border: 2px solid #bee5eb; font-size: 14px;
      `
      
      let content = '<strong>ðŸ’¡ Recommendations:</strong><br>'
      suggestions.forEach((suggestion, index) => {
        content += `<span style="display: block; margin: 4px 0; padding: 4px 8px; background: rgba(255,255,255,0.7); border-radius: 8px;">â€¢ ${suggestion}</span>`
      })
      
      recommendationsDiv.innerHTML = content
      chatFeed.appendChild(recommendationsDiv)
      chatFeed.scrollTop = chatFeed.scrollHeight
    }

    // add recommendations to sidebar
    function addRecommendationsToSidebar(suggestions) {
      currentRecommendations = [...currentRecommendations, ...suggestions]
      displayRecommendations()
    }

    // display recommendations in sidebar
    function displayRecommendations() {
      const recommendationsSection = document.getElementById('recommendationsSection')
      const recommendationsList = document.getElementById('recommendationsList')
      
      if (currentRecommendations.length === 0) {
        recommendationsSection.style.display = 'none'
        return
      }
      
      recommendationsSection.style.display = 'block'
      recommendationsList.innerHTML = ''
      
      currentRecommendations.forEach((recommendation, index) => {
        const recDiv = document.createElement('div')
        recDiv.className = 'recommendation-item'
        recDiv.innerHTML = `
          <input type="checkbox" id="rec_${index}" onchange="toggleRecommendation(${index}, this.checked)">
          <label for="rec_${index}" style="margin-left: 8px; font-size: 14px; cursor: pointer;">${recommendation}</label>
        `
        recommendationsList.appendChild(recDiv)
      })
      
      updateSelectedCount()
    }

    // toggle recommendation selection
    function toggleRecommendation(index, checked) {
      if (checked) {
        selectedRecommendations.add(index)
      } else {
        selectedRecommendations.delete(index)
      }
      updateSelectedCount()
    }

    // select all recommendations
    function selectAllRecommendations() {
      currentRecommendations.forEach((_, index) => {
        selectedRecommendations.add(index)
        document.getElementById(`rec_${index}`).checked = true
      })
      updateSelectedCount()
    }

    // clear all recommendations
    function clearAllRecommendations() {
      selectedRecommendations.clear()
      currentRecommendations.forEach((_, index) => {
        document.getElementById(`rec_${index}`).checked = false
      })
      updateSelectedCount()
    }

    // update selected count display
    function updateSelectedCount() {
      const count = selectedRecommendations.size
      document.getElementById('selectedCount').textContent = `${count} selected`
      
      // Update button text
      const addBtn = document.getElementById('addCalBtn')
      if (count > 0) {
        addBtn.textContent = `Add ${count} Selected to Calendar`
        addBtn.style.background = 'linear-gradient(135deg, #7dd87d, #5cb85c)'
      } else {
        addBtn.textContent = 'Add Selected to Calendar'
        addBtn.style.background = ''
      }
    }

    // add selected recommendations to calendar
    function addSelectedToCalendar() {
      const username = localStorage.getItem('username')
      
      if (!username) {
        alert('Please log in first to add calendar reminders!')
        return
      }
      
      if (selectedRecommendations.size === 0) {
        alert('Please select at least one recommendation to add to your calendar.')
        return
      }
      
      // Show selected items and Google auth modal
      showCalendarAuthModal()
    }

    // show calendar authentication modal
    function showCalendarAuthModal() {
      const modal = document.getElementById('calendarAuthModal')
      const preview = document.getElementById('selectedItemsPreview')
      
      // Show selected recommendations
      let previewHTML = '<h4>Selected Reminders:</h4><ul>'
      selectedRecommendations.forEach(index => {
        previewHTML += `<li>${currentRecommendations[index]}</li>`
      })
      previewHTML += '</ul>'
      
      preview.innerHTML = previewHTML
      modal.style.display = 'flex'
    }

    // close calendar modal
    function closeCalendarModal() {
      document.getElementById('calendarAuthModal').style.display = 'none'
    }

    // connect to Google Calendar
    function connectGoogleCalendar() {
      const username = localStorage.getItem('username')
      const selectedItems = Array.from(selectedRecommendations).map(index => currentRecommendations[index])
      
      // Store selected items for after auth
      localStorage.setItem('pendingCalendarItems', JSON.stringify(selectedItems))
      
      // Redirect to Google OAuth
      window.location.href = `http://localhost:5000/api/calendar/auth?username=${username}&return=calendar_add`
    }

    // clear recommendations
    function clearRecommendations() {
      currentRecommendations = []
      selectedRecommendations.clear()
      document.getElementById('recommendationsSection').style.display = 'none'
    }

    // load existing reminders
    async function loadReminders() {
      const username = localStorage.getItem('username')
      if (!username) return
      
      try {
        const response = await fetch(`http://localhost:5000/api/calendar/reminders/${username}`)
        const data = await response.json()
        
        const reminderList = document.getElementById('reminderList')
        const emptyMsg = document.getElementById('remindersEmpty')
        
        if (data.reminders && data.reminders.length > 0) {
          emptyMsg.style.display = 'none'
          reminderList.innerHTML = ''
          
          data.reminders.forEach(reminder => {
            const div = document.createElement('div')
            div.style.cssText = 'background:#fff;border:1px solid #ddd;border-radius:8px;padding:12px;margin:8px 0'
            div.innerHTML = `
              <strong>${reminder.title}</strong><br>
              <small>${new Date(reminder.datetime).toLocaleDateString()}</small>
            `
            reminderList.appendChild(div)
          })
        } else {
          emptyMsg.style.display = 'block'
          reminderList.innerHTML = ''
        }
      } catch (error) {
        console.log('Couldn\'t load reminders:', error)
      }
    }

    // enter key sends message
    document.getElementById('chatText').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage()
      }
    })

    // check for calendar connection status in URL
    const urlParams = new URLSearchParams(window.location.search)
    if (urlParams.get('calendar') === 'connected') {
      alert('Calendar connected! You can now add reminders')
      loadReminders()
      
      // Check if we have pending calendar items to add
      const pendingItems = localStorage.getItem('pendingCalendarItems')
      if (pendingItems) {
        addPendingItemsToCalendar(JSON.parse(pendingItems))
        localStorage.removeItem('pendingCalendarItems')
      }
    } else if (urlParams.get('calendar') === 'error') {
      alert('Calendar connection failed')
    }

    // add pending items to calendar after successful auth
    async function addPendingItemsToCalendar(items) {
      const username = localStorage.getItem('username')
      
      try {
        for (const item of items) {
          const tomorrow = new Date()
          tomorrow.setDate(tomorrow.getDate() + 1)
          tomorrow.setHours(10, 0, 0, 0)
          
          const reminderData = {
            title: `MAI Reminder: ${item}`,
            description: `Wellness reminder from MAI: ${item}`,
            datetime: tomorrow.toISOString(),
            username: username
          }

          const response = await fetch('http://localhost:5000/api/calendar/add-reminder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reminderData)
          })
          
          const result = await response.json()
          if (!result.success) {
            console.error('Failed to add reminder:', item)
          }
        }
        
        alert(`Successfully added ${items.length} reminders to your calendar!`)
        loadReminders()
        
        // Clear selected recommendations
        clearRecommendations()
        
      } catch (error) {
        console.error('Error adding reminders:', error)
        alert('There was an error adding some reminders to your calendar.')
      }
    }

    // initialize everything when page loads
    window.addEventListener('load', () => {
      loadUserInterface()
      loadReminders()
    })

    // close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('calendarAuthModal')
      if (event.target === modal) {
        closeCalendarModal()
      }
    }
  </script>
</body>
</html>