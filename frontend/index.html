<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MAI</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>

  <header class="topbar">
    <a class="brand" href="index.html">MAI</a>
    <nav class="top-actions">
      <a class="pill" id="loginBtn" href="login.html">Welcome Back, Let's Talk</a>
      <button class="pill" id="logoutBtn" style="display:none;" onclick="handleLogout()">Logout</button>
      <a class="pill" id="profileBtn" href="profile.html">What I've Learned About You So Far</a>
      <button class="pill go-pro-btn" id="goProBtn" onclick="goToPremium()">GO PRO ‚ú®</button>
    </nav>
  </header>

  <main class="shell">
    <!-- quiz results section -->
    <section class="card left">
      <h2 class="title soft">Quiz Results</h2>
      <p class="caring-instruction glowing-text">Want to learn more about you? Take a quiz</p>
      <div class="viz-wrap">
        <div class="viz-circle" id="vizCenter">
          <span class="center-text soft" id="centerLabel">Register or Log in</span>
        </div>

        <!-- quiz buttons positioned around the circle -->
        <button class="orbit pill soft" style="--deg:10deg;"  data-target="quizzes/quiz_personality.html" id="btnPersonality">Personality</button>
        <button class="orbit pill soft" style="--deg:190deg;" data-target="quizzes/quiz_stress.html"       id="btnStress">Stress & Anxiety</button>
        <button class="orbit pill soft" style="--deg:350deg;" data-target="quizzes/quiz_love.html"         id="btnLove">Love Language</button>
        <button class="orbit pill soft" style="--deg:95deg;"  data-target="quizzes/quiz_21.html"           id="btn21">21 Questions</button>
      </div>
    </section>

    <!-- wellness reminders -->
    <section class="card right">
      <h2 class="title soft">Reminders</h2>
      <p class="caring-instruction glowing-text">Fueled by your personal quiz results and our conversations</p>
      
      <!-- Current reminders -->
      <div id="currentReminders" style="margin-bottom: 20px;">
        <p class="muted" id="remindersEmpty">No reminders yet</p>
        <div id="reminderList" class="rem-list"></div>
      </div>

      <!-- Recommendations section -->
      <div id="recommendationsSection" style="display: none;">
        <h3 style="color: var(--ink); font-size: 18px; margin: 15px 0 10px;">MAI's Recommendations</h3>
        <div id="recommendationsList" class="recommendations-list">
          <!-- Recommendations will be populated here -->
        </div>
        <div style="margin: 15px 0 10px; display: flex; gap: 10px; align-items: center;">
          <button class="pill small-pill" onclick="selectAllRecommendations()">Select All</button>
          <button class="pill small-pill" onclick="clearAllRecommendations()">Clear All</button>
          <span id="selectedCount" style="font-size: 14px; color: var(--muted);">0 selected</span>
        </div>
      </div>

      <button class="cta pill soft" id="addCalBtn" onclick="addSelectedToCalendar()">Add Selected to Calendar</button>
    </section>

    <!-- mai chat interface -->
    <section class="card full">
      <h2 class="title soft" style="text-align:center">Talk to MAI</h2>
      <p class="caring-instruction glowing-text" style="text-align:center">Get some guidance from MAI</p>
      <div class="chat-box">
        <div class="chat-feed" id="chatFeed">
          <div class="mai-welcome" id="welcomeMessage">
            <strong>MAI:</strong> Talk to me about anything... Stress at work? Relationship issues? Want to talk out your upcoming week? Let's talk it out here üíú
          </div>
        </div>
        <div class="chat-input">
          <input id="chatText" type="text" placeholder="type a message..." />
          <button id="chatSend" class="pill soft" onclick="sendMessage()">Send</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Google Calendar Auth Modal -->
  <div id="calendarAuthModal" class="calendar-modal" style="display: none;">
    <div class="calendar-modal-content">
      <div class="calendar-modal-header">
        <h3>Connect Google Calendar</h3>
        <button class="modal-close" onclick="closeCalendarModal()">&times;</button>
      </div>
      <div class="calendar-modal-body">
        <p>To add your selected reminders to Google Calendar, please connect your account:</p>
        <div id="selectedItemsPreview" class="selected-items-preview">
          <!-- Selected items will be shown here -->
        </div>
        <div style="margin-top: 20px; text-align: center;">
          <button class="pill" onclick="connectGoogleCalendar()" style="background: #4285f4; font-size: 16px; padding: 15px 30px;">
            Connect Google Calendar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add this JavaScript to your index.html file, replacing the existing chat functions -->

<script>
// Global variables for recommendations (suggestions from MAI)
let currentRecommendations = [];
let selectedRecommendations = new Set();

// Send a message to MAI - this is where the real AI magic happens!
async function sendMessage() {
  const textInput = document.getElementById('chatText')
  const message = textInput.value.trim()  // Get what they typed and remove spaces
  
  // Don't send empty messages
  if (!message) return
  
  // Make sure they're logged in (we need to know who is talking)
  const username = localStorage.getItem('username')
  if (!username) {
    alert('Please log in first to chat with MAI!')
    window.location.href = 'login.html'
    return
  }
  
  // Show their message in the chat
  appendChatMessage('You: ' + message)
  textInput.value = ''  // Clear the input box
  
  // Show that MAI is thinking (this makes it feel more human)
  const thinkingId = appendThinkingMessage()
  
  try {
    console.log('üì§ Sending to backend:', { user_input: message, username })
    
    // Send the message to our backend, which sends it to the AI
    const response = await fetch('http://localhost:5000/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        user_input: message,    // What the user said
        username: username      // Who said it (AI gets their quiz results automatically)
      })
    })
    
    // Remove the "thinking..." indicator
    removeThinkingMessage(thinkingId)
    
    // Check if the request worked
    if (!response.ok) {
      const errorData = await response.json()
      throw new Error(errorData.error || `Server error: ${response.status}`)
    }
    
    // Get the AI's response
    const data = await response.json()
    console.log('üì• Backend response:', data)
    
    // Check if there was an error
    if (data.error) {
      throw new Error(data.error)
    }
    
    // Make sure we got a response from the AI
    const aiResponse = data.response
    if (!aiResponse) {
      throw new Error('No response from AI')
    }
    
    // Show MAI's response in the chat
    appendChatMessage('MAI: ' + aiResponse, 'ai')
    
    // Handle recommendations (wellness suggestions)
    if (data.suggestions && data.suggestions.length > 0) {
      appendRecommendationsBubble(data.suggestions)  // Show in chat
      addRecommendationsToSidebar(data.suggestions)  // Add to sidebar
    }
    
    // Log AI status (for debugging)
    if (data.debug_info) {
      console.log('ü§ñ AI Status:', {
        ai_powered: data.ai_powered,
        no_templates: data.no_templates,
        response_length: data.debug_info.response_length
      })
    }
    
  } catch (error) {
    console.error('üí• Chat error:', error)
    
    // Remove thinking indicator if something went wrong
    removeThinkingMessage(thinkingId)
    
    // Show helpful error messages based on what went wrong
    let errorMessage = 'MAI: '
    
    if (error.message.includes('AI brain is offline')) {
      errorMessage += "I'm having trouble connecting to my AI brain right now. The person running me needs to start the FastAPI server by running: cd fastapi_ai && python main.py"
    } else if (error.message.includes('taking longer than usual')) {
      errorMessage += "I'm thinking extra hard about your question - it's taking longer than usual. Please try again in a moment."
    } else if (error.message.includes('AI system isn\'t fully set up')) {
      errorMessage += "My AI system isn't fully configured yet. Please check that both my training data and Gemini API key are properly set up."
    } else if (error.message.includes('need to be logged in')) {
      errorMessage += "I need you to be logged in to have a proper conversation. Please log in and try again."
      setTimeout(() => window.location.href = 'login.html', 2000)  // Redirect to login after 2 seconds
    } else if (error.message.includes('Server error: 503')) {
      errorMessage += "My AI services are temporarily unavailable. Please make sure the FastAPI server is running and try again."
    } else {
      errorMessage += "I'm experiencing some technical difficulties right now. Please try again in a moment. If this continues, please check that my AI system is properly set up."
    }
    
    appendChatMessage(errorMessage)
  }
}

// Show the "thinking..." animation while MAI is processing
function appendThinkingMessage() {
  const chatFeed = document.getElementById('chatFeed')
  const thinkingDiv = document.createElement('div')
  const thinkingId = 'thinking_' + Date.now()  // Unique ID for this thinking message
  
  thinkingDiv.id = thinkingId
  thinkingDiv.style.cssText = `
    margin: 8px 0; padding: 8px 12px; border-radius: 12px;
    background: #f8f5ff; border: 1px solid #e0d4ff;
    color: #5a4fcf; font-style: italic;
  `
  thinkingDiv.innerHTML = '<strong>MAI:</strong> <span class="thinking-dots">Thinking</span>'
  
  chatFeed.appendChild(thinkingDiv)
  chatFeed.scrollTop = chatFeed.scrollHeight  // Scroll to bottom
  
  // Animate the dots (...) to show MAI is thinking
  const dotsSpan = thinkingDiv.querySelector('.thinking-dots')
  let dotCount = 0
  const thinkingInterval = setInterval(() => {
    dotCount = (dotCount + 1) % 4  // Cycle through 0, 1, 2, 3
    dotsSpan.textContent = 'Thinking' + '.'.repeat(dotCount)  // "Thinking", "Thinking.", "Thinking..", "Thinking..."
  }, 500)  // Update every half second
  
  // Store the interval so we can stop it later
  thinkingDiv.thinkingInterval = thinkingInterval
  
  return thinkingId
}

// Remove the thinking message when MAI responds
function removeThinkingMessage(thinkingId) {
  const thinkingDiv = document.getElementById(thinkingId)
  if (thinkingDiv) {
    // Stop the thinking animation
    if (thinkingDiv.thinkingInterval) {
      clearInterval(thinkingDiv.thinkingInterval)
    }
    thinkingDiv.remove()  // Remove from the chat
  }
}

// Add a message to the chat display
function appendChatMessage(message, type = 'normal') {
  const chatFeed = document.getElementById('chatFeed')
  const messageDiv = document.createElement('div')
  
  // Basic styling for all messages
  messageDiv.style.margin = '8px 0'
  messageDiv.style.padding = '8px 12px'
  messageDiv.style.borderRadius = '12px'
  messageDiv.style.wordWrap = 'break-word'  // Wrap long words
  messageDiv.style.lineHeight = '1.4'
  
  // Style user messages differently from MAI messages
  if (message.startsWith('You:')) {
    // User messages (right side, purple background)
    messageDiv.style.background = 'linear-gradient(135deg, #f0c6ff, #e8c8ff)'
    messageDiv.style.marginLeft = '20px'
    messageDiv.style.textAlign = 'right'
    messageDiv.style.color = '#1f133a'
    messageDiv.style.fontWeight = '600'
  } else if (message.startsWith('MAI:')) {
    // MAI messages (left side, white background)
    messageDiv.style.background = '#fff'
    messageDiv.style.border = '1px solid #e0d4ff'
    messageDiv.style.color = '#2e2156'
    
    // Highlight AI-powered responses with a green border
    if (type === 'ai') {
      messageDiv.style.borderLeft = '4px solid #7dd87d'
      messageDiv.style.paddingLeft = '12px'
    }
  }
  
  messageDiv.textContent = message
  chatFeed.appendChild(messageDiv)
  chatFeed.scrollTop = chatFeed.scrollHeight  // Always scroll to the bottom
}

// Show recommendations in a chat bubble
function appendRecommendationsBubble(suggestions) {
  const chatFeed = document.getElementById('chatFeed')
  const recommendationsDiv = document.createElement('div')
  
  // Style the recommendations bubble
  recommendationsDiv.style.cssText = `
    margin: 8px 0; padding: 12px; border-radius: 12px;
    background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
    border: 2px solid #bee5eb; font-size: 14px;
  `
  
  // Build the content
  let content = '<strong>üí° Wellness Recommendations:</strong><br>'
  suggestions.forEach((suggestion, index) => {
    content += `<span style="display: block; margin: 4px 0; padding: 4px 8px; background: rgba(255,255,255,0.7); border-radius: 8px;">‚Ä¢ ${suggestion}</span>`
  })
  
  recommendationsDiv.innerHTML = content
  chatFeed.appendChild(recommendationsDiv)
  chatFeed.scrollTop = chatFeed.scrollHeight
}

// Add recommendations to the sidebar for calendar scheduling
function addRecommendationsToSidebar(suggestions) {
  currentRecommendations = [...currentRecommendations, ...suggestions]
  displayRecommendations()
}

// Display recommendations in the sidebar
function displayRecommendations() {
  const recommendationsSection = document.getElementById('recommendationsSection')
  const recommendationsList = document.getElementById('recommendationsList')
  
  // Hide section if no recommendations
  if (currentRecommendations.length === 0) {
    recommendationsSection.style.display = 'none'
    return
  }
  
  // Show the section and build the list
  recommendationsSection.style.display = 'block'
  recommendationsList.innerHTML = ''
  
  currentRecommendations.forEach((recommendation, index) => {
    const recDiv = document.createElement('div')
    recDiv.className = 'recommendation-item'
    recDiv.innerHTML = `
      <input type="checkbox" id="rec_${index}" onchange="toggleRecommendation(${index}, this.checked)">
      <label for="rec_${index}" style="margin-left: 8px; font-size: 14px; cursor: pointer;">${recommendation}</label>
    `
    recommendationsList.appendChild(recDiv)
  })
  
  updateSelectedCount()
}

// Handle selecting/deselecting recommendations
function toggleRecommendation(index, checked) {
  if (checked) {
    selectedRecommendations.add(index)
  } else {
    selectedRecommendations.delete(index)
  }
  updateSelectedCount()
}

// Select all recommendations at once
function selectAllRecommendations() {
  currentRecommendations.forEach((_, index) => {
    selectedRecommendations.add(index)
    document.getElementById(`rec_${index}`).checked = true
  })
  updateSelectedCount()
}

// Clear all selected recommendations
function clearAllRecommendations() {
  selectedRecommendations.clear()
  currentRecommendations.forEach((_, index) => {
    document.getElementById(`rec_${index}`).checked = false
  })
  updateSelectedCount()
}

// Update the count display and button text
function updateSelectedCount() {
  const count = selectedRecommendations.size
  document.getElementById('selectedCount').textContent = `${count} selected`
  
  // Update the calendar button
  const addBtn = document.getElementById('addCalBtn')
  if (count > 0) {
    addBtn.textContent = `Add ${count} Selected to Calendar`
    addBtn.style.background = 'linear-gradient(135deg, #7dd87d, #5cb85c)'
  } else {
    addBtn.textContent = 'Add Selected to Calendar'
    addBtn.style.background = ''
  }
}

// Load user chat history when they log in
async function loadChatHistory() {
  const username = localStorage.getItem('username')
  if (!username) return
  
  try {
    console.log(`üìä Loading chat history for ${username}`)
    const response = await fetch(`http://localhost:5000/api/chat/history/${username}`)
    if (response.ok) {
      const stats = await response.json()
      console.log('‚úÖ User chat stats:', stats)
      
      // You could display stats somewhere in the UI if desired
      if (stats.total_conversations > 0) {
        console.log(`${username} has had ${stats.total_conversations} conversations with MAI`)
      }
    }
  } catch (error) {
    console.log('‚ö†Ô∏è  Could not load chat history:', error.message)
  }
}

// Set up the user interface when the page loads
function loadUserInterface(){
  const user = localStorage.getItem('username')
  
  if (user) {
    // User is logged in - personalize the interface
    document.getElementById('centerLabel').textContent = `hey ${user}!`
    document.getElementById('loginBtn').style.display = 'none'
    document.getElementById('logoutBtn').style.display = 'inline-block'
    
    // Update welcome message to mention AI capabilities
    document.getElementById('welcomeMessage').innerHTML = 
      `<strong>MAI:</strong> Welcome back, ${user}! I'm now powered by real AI and remember our conversations. What's on your mind? üíú`
    
    // Load their chat history for context
    loadChatHistory()
    
  } else {
    // User is not logged in
    document.getElementById('loginBtn').style.display = 'inline-block'
    document.getElementById('logoutBtn').style.display = 'none'
    
    // Show AI capabilities in welcome message
    document.getElementById('welcomeMessage').innerHTML = 
      `<strong>MAI:</strong> I'm powered by advanced AI! Log in so I can remember our conversations and personalize my responses to your personality and needs üíú`
  }

  // Update quiz button labels with completed results
  const personality = localStorage.getItem('quiz_personality') || 'Personality'
  const stress = localStorage.getItem('quiz_stress') || 'Stress & Anxiety'  
  const love = localStorage.getItem('quiz_love') || 'Love Language'
  const questions21 = localStorage.getItem('quiz_21') || '21 Questions'
  
  document.getElementById('btnPersonality').textContent = personality
  document.getElementById('btnStress').textContent = stress
  document.getElementById('btnLove').textContent = love
  document.getElementById('btn21').textContent = questions21
}

// Handle logout
function handleLogout() {
  if (confirm('Are you sure you want to log out?')) {
    // Clear user data
    localStorage.removeItem('username')
    localStorage.removeItem('email')
    
    // Reset interface
    loadUserInterface()
    alert('Logged out successfully!')
    
    // Clear chat and recommendations
    document.getElementById('chatFeed').innerHTML = `
      <div class="mai-welcome">
        <strong>MAI:</strong> I'm powered by advanced AI! Log in so I can remember our conversations and personalize my responses üíú
      </div>
    `
    clearRecommendations()
  }
}

// Clear all recommendations
function clearRecommendations() {
  currentRecommendations = []
  selectedRecommendations.clear()
  document.getElementById('recommendationsSection').style.display = 'none'
}

// Handle Enter key in chat input
document.addEventListener('DOMContentLoaded', function() {
  const chatInput = document.getElementById('chatText')
  if (chatInput) {
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage()
      }
    })
  }
  
  // Initialize the interface
  loadUserInterface()
})

// Initialize everything when page loads
window.addEventListener('load', () => {
  loadUserInterface()
})
  </script>
</body>
</html>