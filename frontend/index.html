<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MAI</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>

  <header class="topbar">
    <a class="brand" href="index.html">MAI</a>
    <nav class="top-actions">
      <a class="pill" id="loginBtn" href="login.html">Login</a>
      <button class="pill" id="logoutBtn" style="display:none;" onclick="handleLogout()">Logout</button>
      <a class="pill" id="profileBtn" href="profile.html">Profile</a>
      <button class="pill go-pro-btn" id="goProBtn" onclick="goToPremium()">GO PRO âœ¨</button>
    </nav>
  </header>

  <main class="shell">
    <!-- quiz results section -->
    <section class="card left">
      <h2 class="title soft">Quiz Results</h2>
      <p class="caring-instruction glowing-text">Want to learn more about you? Take a quiz</p>
      <div class="viz-wrap">
        <div class="viz-circle" id="vizCenter">
          <span class="center-text soft" id="centerLabel">Register or Log in</span>
        </div>

        <!-- quiz buttons positioned around the circle -->
        <button class="orbit pill soft" style="--deg:10deg;"  data-target="quizzes/quiz_personality.html" id="btnPersonality">Personality</button>
        <button class="orbit pill soft" style="--deg:190deg;" data-target="quizzes/quiz_stress.html"       id="btnStress">Stress & Anxiety</button>
        <button class="orbit pill soft" style="--deg:350deg;" data-target="quizzes/quiz_love.html"         id="btnLove">Love Language</button>
        <button class="orbit pill soft" style="--deg:95deg;"  data-target="quizzes/quiz_21.html"           id="btn21">21 Questions</button>
      </div>
    </section>

    <!-- wellness reminders -->
    <section class="card right">
      <h2 class="title soft">Reminders</h2>
      <p class="caring-instruction glowing-text">Fueled by your personal quiz results and our conversations</p>
      <p class="muted" id="remindersEmpty">No reminders yet</p>
      <div id="reminderList" class="rem-list"></div>
      <button class="cta pill soft" id="addCalBtn" onclick="addWellnessReminder()">Add Reminders to your Calendar</button>
    </section>

    <!-- mai chat interface -->
    <section class="card full">
      <h2 class="title soft" style="text-align:center">Talk to MAI</h2>
      <p class="caring-instruction glowing-text" style="text-align:center">Get some guidance from MAI</p>
      <div class="chat-box">
        <div class="chat-feed" id="chatFeed">
          <div class="mai-welcome" id="welcomeMessage">
            <strong>MAI:</strong> Talk to me about anything... Stress at work? Relationship issues? Want to talk out your upcoming week? Let's talk it out here ðŸ’œ
          </div>
        </div>
        <div class="chat-input">
          <input id="chatText" type="text" placeholder="type a message..." />
          <button id="chatSend" class="pill soft" onclick="sendMessage()">Send</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // load user data and update UI
    function loadUserInterface(){
      const user = localStorage.getItem('username')
      
      if (user) {
        // user is logged in
        document.getElementById('centerLabel').textContent = `hey ${user}!`
        
        // show logout button, hide login button
        document.getElementById('loginBtn').style.display = 'none'
        document.getElementById('logoutBtn').style.display = 'inline-block'
        
        // update welcome message to be more personal
        document.getElementById('welcomeMessage').innerHTML = 
          `<strong>MAI:</strong> Welcome back, ${user}! I'm here whenever you need to talk. What's been on your mind lately? ðŸ’œ`
        
      } else {
        // user is not logged in
        document.getElementById('loginBtn').style.display = 'inline-block'
        document.getElementById('logoutBtn').style.display = 'none'
        
        // keep default welcome message
        document.getElementById('welcomeMessage').innerHTML = 
          `<strong>MAI:</strong> Talk to me about anything... Stress at work? Relationship issues? Want to talk out your upcoming week? Let's talk it out here ðŸ’œ`
      }

      // update quiz buttons with results
      const personality = localStorage.getItem('quiz_personality') || 'Personality'
      const stress = localStorage.getItem('quiz_stress') || 'Stress & Anxiety'  
      const love = localStorage.getItem('quiz_love') || 'Love Language'
      const questions21 = localStorage.getItem('quiz_21') || '21 Questions'
      
      document.getElementById('btnPersonality').textContent = personality
      document.getElementById('btnStress').textContent = stress
      document.getElementById('btnLove').textContent = love
      document.getElementById('btn21').textContent = questions21
    }

    // logout functionality
    function handleLogout() {
      // confirm logout
      if (confirm('Are you sure you want to log out?')) {
        // clear all user data
        localStorage.removeItem('username')
        localStorage.removeItem('email')
        
        // update UI immediately
        loadUserInterface()
        
        // show success message
        alert('Logged out successfully!')
        
        // clear chat history
        document.getElementById('chatFeed').innerHTML = `
          <div class="mai-welcome">
            <strong>MAI:</strong> Talk to me about anything... Stress at work? Relationship issues? Want to talk out your upcoming week? Let's talk it out here ðŸ’œ
          </div>
        `
      }
    }

    // go to premium page
    function goToPremium() {
      window.location.href = 'premium.html'
    }

    // quiz button navigation
    document.querySelectorAll('.orbit').forEach(button => {
      button.addEventListener('click', () => {
        window.location.href = button.dataset.target
      })
    })

    // send chat message
    async function sendMessage() {
      const textInput = document.getElementById('chatText')
      const message = textInput.value.trim()
      
      if (!message) return
      
      // add user message to chat
      appendChatMessage('You: ' + message)
      textInput.value = ''
      
      // get user context
      const username = localStorage.getItem('username') || ''
      const personality = localStorage.getItem('quiz_personality') || ''
      const stress = localStorage.getItem('quiz_stress') || ''
      const love = localStorage.getItem('quiz_love') || ''
      const quiz21 = localStorage.getItem('quiz_21') || ''
      const quizSummary = `${personality}, ${stress}, ${love}, ${quiz21}`.replace(/^,+|,+$/g, '')
      
      try {
        // call backend API (which calls FastAPI)
        const response = await fetch('http://localhost:5000/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            user_input: message,
            username: username,
            quiz_summary: quizSummary
          })
        })
        
        const data = await response.json()
        const aiResponse = data.response || 'Tell me more about that. I\'m here to listen.'
        
        // add AI response to chat
        appendChatMessage('MAI: ' + aiResponse)
        
        // show suggestions if available
        if (data.suggestions && data.suggestions.length > 0) {
          const suggestionText = 'Suggestions: ' + data.suggestions.join(', ')
          appendChatMessage(suggestionText, 'suggestion')
        }
        
        // suggest calendar reminder for certain keywords
        if (message.toLowerCase().includes('remind') || message.toLowerCase().includes('forget')) {
          setTimeout(() => {
            appendChatMessage('MAI: Would you like me to add a wellness reminder to your calendar? Click the button above!')
          }, 1000)
        }
        
      } catch (error) {
        console.error('Chat error:', error)
        appendChatMessage('MAI: I\'m having trouble connecting right now, but I\'m still here for you. Can you tell me more about how you\'re feeling?')
      }
    }

    // add message to chat feed
    function appendChatMessage(message, type = 'normal') {
      const chatFeed = document.getElementById('chatFeed')
      const messageDiv = document.createElement('div')
      
      messageDiv.textContent = message
      messageDiv.style.margin = '8px 0'
      messageDiv.style.padding = '8px 12px'
      messageDiv.style.borderRadius = '12px'
      
      if (message.startsWith('You:')) {
        messageDiv.style.background = '#f0c6ff'
        messageDiv.style.marginLeft = '20px'
        messageDiv.style.textAlign = 'right'
      } else if (type === 'suggestion') {
        messageDiv.style.background = '#e8f4fd'
        messageDiv.style.border = '1px solid #bee5eb'
        messageDiv.style.fontSize = '14px'
        messageDiv.style.fontStyle = 'italic'
      } else {
        messageDiv.style.background = '#fff'
        messageDiv.style.border = '1px solid #e0e0e0'
      }
      
      chatFeed.appendChild(messageDiv)
      chatFeed.scrollTop = chatFeed.scrollHeight
    }

    // add wellness reminder
    async function addWellnessReminder() {
      const username = localStorage.getItem('username')
      
      if (!username) {
        alert('Please log in first to add calendar reminders!')
        return
      }
      
      // create reminder for tomorrow at 10 AM
      const tomorrow = new Date()
      tomorrow.setDate(tomorrow.getDate() + 1)
      tomorrow.setHours(10, 0, 0, 0)
      
      const reminderData = {
        title: 'MAI wellness check-in',
        description: 'Time for a quick mental health check-in. How are you feeling today?',
        datetime: tomorrow.toISOString(),
        username: username
      }

      try {
        const response = await fetch('http://localhost:5000/api/calendar/add-reminder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(reminderData)
        })
        
        const result = await response.json()
        
        if (result.success) {
          alert('Wellness reminder added to your calendar!')
          loadReminders()
        } else if (result.authUrl) {
          window.open(result.authUrl, '_blank')
          alert('Please connect your Google Calendar first, then try again')
        } else {
          alert('Couldn\'t add reminder: ' + (result.error || 'Unknown error'))
        }
      } catch (error) {
        console.error('Calendar error:', error)
        alert('Something went wrong with the calendar integration')
      }
    }

    // load existing reminders
    async function loadReminders() {
      const username = localStorage.getItem('username')
      if (!username) return
      
      try {
        const response = await fetch(`http://localhost:5000/api/calendar/reminders/${username}`)
        const data = await response.json()
        
        const reminderList = document.getElementById('reminderList')
        const emptyMsg = document.getElementById('remindersEmpty')
        
        if (data.reminders && data.reminders.length > 0) {
          emptyMsg.style.display = 'none'
          reminderList.innerHTML = ''
          
          data.reminders.forEach(reminder => {
            const div = document.createElement('div')
            div.style.cssText = 'background:#fff;border:1px solid #ddd;border-radius:8px;padding:12px;margin:8px 0'
            div.innerHTML = `
              <strong>${reminder.title}</strong><br>
              <small>${new Date(reminder.datetime).toLocaleDateString()}</small>
            `
            reminderList.appendChild(div)
          })
        } else {
          emptyMsg.style.display = 'block'
          reminderList.innerHTML = ''
        }
      } catch (error) {
        console.log('Couldn\'t load reminders:', error)
      }
    }

    // enter key sends message
    document.getElementById('chatText').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage()
      }
    })

    // check for calendar connection status in URL
    const urlParams = new URLSearchParams(window.location.search)
    if (urlParams.get('calendar') === 'connected') {
      alert('Calendar connected! You can now add reminders')
      loadReminders()
    } else if (urlParams.get('calendar') === 'error') {
      alert('Calendar connection failed')
    }

    // initialize everything when page loads
    window.addEventListener('load', () => {
      loadUserInterface()
      loadReminders()
    })
  </script>
</body>
</html>